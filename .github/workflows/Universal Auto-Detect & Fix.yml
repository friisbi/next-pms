name: Universal Auto-Detect & Fix

permissions:
  contents: write

on:
  workflow_dispatch: # Avvio manuale
  schedule:
    - cron: '*/30 * * * *' # Ogni 30 min

jobs:
  smart-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'Smart Bot'
          git config --global user.email 'bot@noreply.github.com'

      - name: Auto-Detect, Backup & Sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üïµÔ∏è Avvio procedura Autopilot..."
          
          # --- FASE 1: BACKUP (BUNKER) ---
          echo "üõ°Ô∏è Metto al sicuro i workflow..."
          mkdir -p /tmp/my_workflows
          cp -r .github/workflows/* /tmp/my_workflows/
          # -------------------------------

          # --- FASE 2: SCOPERTA DEL PROPRIETARIO (AUTO-DETECT) ---
          # Chiediamo all'API di GitHub chi √® il "Genitore" di questa fork
          UPSTREAM_URL=$(gh api "repos/${{ github.repository }}" --jq '.parent.clone_url' || true)

          # Se l'API fallisce o restituisce vuoto (es. non √® una fork ufficiale), usiamo il fallback
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" == "null" ]; then
             echo "‚ö†Ô∏è Non riesco a rilevare il genitore tramite API (forse non hai usato il tasto Fork?)."
             REPO_NAME=$(echo "${{ github.repository }}" | awk -F '/' '{print $2}')
             echo "üîÑ Provo il fallback standard su: frappe/$REPO_NAME"
             UPSTREAM_URL="https://github.com/frappe/${REPO_NAME}.git"
          else
             echo "‚úÖ Genitore rilevato automaticamente: $UPSTREAM_URL"
          fi
          
          # --- FASE 3: SINCRONIZZAZIONE INTELLIGENTE ---
          if ! git ls-remote "$UPSTREAM_URL" > /dev/null 2>&1; then
             echo "‚ùå ERRORE: La repo originale non esiste o non √® raggiungibile."
             # Non facciamo exit 1 per permettere almeno la pulizia dei file, ma saltiamo il reset
          else
             echo "üîó Collegamento a upstream..."
             git remote remove upstream 2>/dev/null || true
             git remote add upstream "$UPSTREAM_URL"
             git fetch upstream

             # Cerca il branch giusto (develop -> main -> master)
             TARGET_BRANCH=""
             for branch in "develop" "main" "master"; do
                 if git ls-remote --exit-code --heads upstream "$branch" >/dev/null 2>&1; then
                     TARGET_BRANCH="$branch"
                     break
                 fi
             done

             if [ -z "$TARGET_BRANCH" ]; then
                 echo "‚ö†Ô∏è Nessun branch valido trovato (develop/main/master). Salto l'aggiornamento."
             else
                 echo "üîÑ Resetto il codice sul branch: $TARGET_BRANCH"
                 git checkout -B "$TARGET_BRANCH" "upstream/$TARGET_BRANCH"
             fi
          fi
          
          # --- FASE 4: RIPRISTINO (TORNA LO SCRIPT) ---
          echo "üõ°Ô∏è Ripristino i workflow dal bunker..."
          mkdir -p .github/workflows
          cp -r /tmp/my_workflows/* .github/workflows/
          # --------------------------------------------

          # --- FASE 5: FIX DIPENDENZE (Toglie 'frappe/') ---
          if [ -f "pyproject.toml" ]; then
             if grep -q "frappe/" "pyproject.toml" || true; then
                sed -i 's|"frappe/\([^"]*\)"|"\1"|g' pyproject.toml
             fi
          fi
          
          # Fix hooks.py (gestisce apici singoli e doppi)
          if grep -r "frappe/" . --include="hooks.py" > /dev/null 2>&1 || true; then
             find . -name "hooks.py" -exec sed -i "s|'frappe/\([^']*\)'|'\1'|g" {} +
             find . -name "hooks.py" -exec sed -i 's|"frappe/\([^"]*\)"|"\1"|g' {} +
          fi

          # --- FASE 6: PULIZIA FILE SPAZZATURA ---
          echo "üßπ Pulizia file workflow inutili..."
          rm -f .github/workflows/build_assets.yml
          rm -f .github/workflows/publish-assets-develop.yml
          rm -f .github/workflows/build-publish.yml
          rm -f .github/workflows/ci.yml
          rm -f .github/workflows/semgrep.yml
          rm -f .github/workflows/test.yml

          # --- FASE 7: SALVA E SPINGE ---
          git add .
          git commit -m "Auto-fix: Autopilot Sync & Clean" || echo "‚ö†Ô∏è Nessuna modifica da salvare (Tutto pulito!)"
          
          # Push dinamico sul branch che abbiamo rilevato
          if [ ! -z "$TARGET_BRANCH" ]; then
              git push -f origin "$TARGET_BRANCH"
          else
              git push -f origin HEAD
          fi
